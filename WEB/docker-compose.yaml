version: '3.8'

services:
  web-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: web-service:latest
    container_name: web-service

    # 端口映射
    ports:
      - "${WEB_PORT:-8888}:80"

    # 数据卷挂载
    volumes:
      # 前端构建产物目录
      - ./dist:/usr/share/nginx/html:ro
      # Nginx配置文件
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      # Nginx日志目录
      - ./logs:/var/log/nginx
      # SSL证书（如果存在）
      - ./conf/ssl:/etc/nginx/ssl:ro
      # 时区文件挂载
      - /etc/localtime:/etc/localtime:ro

    # 环境变量
    environment:
      # 时区配置
      - TZ=Asia/Shanghai

    # 添加hosts映射，使容器能够通过gateway访问主机上的服务
    # 由于iot-gateway使用host网络模式，需要通过主机IP访问
    extra_hosts:
      - "gateway:host-gateway"
      # 如果host-gateway不支持，可以使用以下方式（需要替换为实际的主机IP）
      # - "gateway:172.17.0.1"

    # 重启策略
    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 网络配置（连接到统一网络，以便访问AI和VIDEO服务）
    networks:
      - easyaiot-network

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  easyaiot-network:
    name: easyaiot-network
    external: true

