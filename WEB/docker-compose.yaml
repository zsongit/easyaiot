services:
  web-service:
    image: web-service:latest
    container_name: web-service
    user: root

    # 端口映射
    ports:
      - "${WEB_PORT:-8888}:80"

    # 数据卷挂载
    volumes:
      # Nginx配置文件
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      # Nginx日志目录
      - ./logs:/var/log/nginx
      # SSL证书（如果存在）
      - ./conf/ssl:/etc/nginx/ssl:ro
      # 时区文件挂载
      - /etc/localtime:/etc/localtime:ro

    # 环境变量
    environment:
      # 时区配置
      - TZ=Asia/Shanghai

    # 添加hosts映射，使容器能够通过gateway访问主机上的服务
    # 由于iot-gateway、video-service和ai-service使用host网络模式，需要通过主机IP访问
    # 
    # 云端服务器部署说明：
    # 1. 首先尝试使用 host-gateway（Docker 20.10+支持）
    # 2. 如果 host-gateway 不工作（nginx报499错误），需要手动配置宿主机IP
    # 3. 获取宿主机IP的方法：
    #    - 在宿主机执行: ip addr show docker0 | grep "inet " | awk '{print $2}' | cut -d/ -f1
    #    - 或者: hostname -I | awk '{print $1}'
    #    - 或者: ip route | grep default | awk '{print $3}'
    # 4. 将下面的注释取消，并替换为实际的宿主机IP地址
    extra_hosts:
      - "gateway:host-gateway"
      - "video-host:host-gateway"  # 用于访问使用host网络模式的video-service（端口6000）
      - "ai-host:host-gateway"  # 用于访问使用host网络模式的ai-service（端口5000）
      - "srs-host:host-gateway"  # 用于访问使用host网络模式的SRS服务（端口1985）
      # 云端服务器备用方案：如果host-gateway不工作，取消下面的注释并替换为实际IP（注意！！这里的-绝对不能多出来多余的空格，否则配置失效导致nginx无法访问对应的服务！！）
      # 示例（请根据实际情况修改）：
     # - "gateway:192.168.11.28"        # Docker默认网关IP
     # - "video-host:192.168.11.28"     # 宿主机IP（用于访问video-service:6000）
     # - "ai-host:192.168.11.28"        # 宿主机IP（用于访问ai-service:5000）
     # - "srs-host:192.168.11.28"       # 宿主机IP（用于访问SRS服务:1985）
      # 或者使用宿主机实际IP（推荐）：
      # - "gateway:YOUR_HOST_IP"      # 替换YOUR_HOST_IP为实际宿主机IP
      # - "video-host:YOUR_HOST_IP"   # 替换YOUR_HOST_IP为实际宿主机IP
      # - "ai-host:YOUR_HOST_IP"      # 替换YOUR_HOST_IP为实际宿主机IP
      # - "srs-host:YOUR_HOST_IP"     # 替换YOUR_HOST_IP为实际宿主机IP

    # 重启策略
    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 网络配置（连接到统一网络，以便访问AI和VIDEO服务）
    networks:
      - easyaiot-network

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  easyaiot-network:
    name: easyaiot-network
    external: true

