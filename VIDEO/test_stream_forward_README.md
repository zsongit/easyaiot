# 推流转发服务测试脚本使用说明

## 简介

本文档介绍推流转发服务相关的测试脚本使用方法，包括：
- `test_stream_forward.py` - 推流转发服务畅通性测试脚本

---

## 一、test_stream_forward.py（推流转发服务畅通性测试脚本）

### 简介

`test_stream_forward.py` 是一个用于测试 `stream_forward_service` 畅通性的测试脚本。该脚本使用 MP4 文件（`video/video2.mp4`）作为输入源，模拟 RTSP 流输入，测试推流转发服务的核心功能是否正常工作。

## 功能特性

- ✅ 检查 FFmpeg 是否安装
- ✅ 检查视频文件是否存在且可读
- ✅ 测试视频流可读性
- ✅ 测试推流转发服务核心功能：
  - 从源读取视频帧
  - 缩放视频帧到目标分辨率
  - 推送到 RTMP 服务器
- ✅ 实时监控推流状态
- ✅ 统计处理的帧数
- ✅ 错误检测和报告

## 使用方法

### 基本用法

```bash
cd /opt/projects/easyaiot/VIDEO
python test_stream_forward.py
```

### 配置参数

可以通过环境变量配置测试参数：

```bash
# 设置 RTMP 输出地址（默认: rtmp://127.0.0.1:1935/live/test_stream）
export TEST_RTMP_URL=rtmp://your-rtmp-server:1935/live/stream_name

# 运行测试
python test_stream_forward.py
```

### 测试时长

默认测试时长为 60 秒，可以在脚本中修改 `TEST_DURATION` 变量来调整。

## 测试流程

1. **环境检查**
   - 检查 FFmpeg 是否安装
   - 检查视频文件是否存在

2. **流可读性测试**
   - 尝试打开视频文件
   - 读取前 10 帧验证流是否可读

3. **核心功能测试**
   - 打开视频流
   - 启动 FFmpeg RTMP 推流进程
   - 循环读取帧、缩放、推送到 RTMP
   - 监控推流状态和帧数

4. **测试总结**
   - 显示测试结果统计
   - 列出所有错误（如果有）

## 输出示例

```
============================================================
推流转发服务畅通性测试
============================================================
视频文件: /opt/projects/easyaiot/VIDEO/video/video2.mp4
RTSP 地址: rtsp://127.0.0.1:8554/test_stream
RTMP 地址: rtmp://127.0.0.1:1935/live/test_stream
测试时长: 60 秒
============================================================
✅ FFmpeg 已安装: ffmpeg version 4.4.2
✅ 视频文件信息:
   文件路径: /opt/projects/easyaiot/VIDEO/video/video2.mp4
   分辨率: 1920x1080
   帧率: 25.00 FPS
   总帧数: 2500
   时长: 100.00 秒
🔍 测试流可读性...
✅ 流可读，成功读取 10 帧
🔍 测试推流转发服务核心功能...
📹 打开源流...
✅ 源流已打开
   原始分辨率: 1920x1080
   原始帧率: 25.00 FPS
📺 启动 RTMP 推流进程...
✅ RTMP 推流进程已启动 (PID: 12345)
🔄 开始读取帧并推流...
   测试持续时间: 60 秒
   按 Ctrl+C 提前停止测试
   已处理 150 帧，耗时 5.0 秒，实际帧率: 15.00 FPS
   ...
✅ 推流测试完成，共处理 900 帧
✅ RTMP 推流进程已停止

============================================================
测试总结
============================================================
✅ 流可读: 是
✅ RTMP 推流: 成功
📊 接收帧数: 10
📊 处理帧数: 900

✅ 未发现错误
============================================================
✅ 推流转发服务畅通性测试通过！
```

## 注意事项

1. **RTMP 服务器**
   - 确保 RTMP 服务器（如 SRS）正在运行
   - 如果 RTMP 服务器不可用，推流会失败，但不会影响其他测试

2. **视频文件**
   - 默认使用 `video/video2.mp4`
   - 确保文件存在且可读
   - 支持常见的视频格式（MP4、AVI 等）

3. **FFmpeg**
   - 必须安装 FFmpeg
   - 建议版本 4.0 或更高

4. **测试中断**
   - 可以随时按 `Ctrl+C` 中断测试
   - 脚本会优雅地清理资源

## 故障排查

### FFmpeg 未安装

```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# macOS
brew install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg
```

### 视频文件不存在

确保 `video/video2.mp4` 文件存在，或者修改脚本中的 `VIDEO_FILE` 变量指向正确的文件路径。

### RTMP 推流失败

1. 检查 RTMP 服务器是否运行
2. 检查 RTMP 地址是否正确
3. 检查网络连接
4. 查看错误日志了解详细原因

### 无法读取视频帧

1. 检查视频文件是否损坏
2. 检查文件权限
3. 尝试使用其他视频文件

## 测试指标

测试脚本会统计以下指标：

- **接收帧数**: 从源流成功读取的帧数
- **处理帧数**: 成功处理并推送到 RTMP 的帧数
- **实际帧率**: 实际处理的帧率（FPS）
- **错误数量**: 测试过程中遇到的错误数

## 扩展测试

如果需要测试更长时间或不同的视频文件，可以：

1. 修改 `TEST_DURATION` 变量
2. 修改 `VIDEO_FILE` 变量指向其他视频文件
3. 修改目标分辨率（`target_width` 和 `target_height`）
4. 修改目标帧率（`source_fps`）

---

## 相关文件

- `services/stream_forward_service/run_deploy.py` - 推流转发服务主程序
- `test_stream_forward.py` - 推流转发服务畅通性测试脚本
- `test_rtsp.py` - RTSP 到 RTMP 推流测试脚本

## 作者信息

- **作者**: 翱翔的雄库鲁
- **邮箱**: andywebjava@163.com
- **微信**: EasyAIoT2025
