# 关闭所有 realtime_algorithm_service 进程脚本

## 功能说明

这个脚本用于强制关闭所有 `realtime_algorithm_service` 相关的进程，包括：
- `run_deploy.py` 主进程
- 所有 FFmpeg 子进程
- 其他相关子进程

## 使用方法

### 1. 关闭所有相关进程（需要确认）

```bash
python VIDEO/kill_all_realtime_processes.py
```

### 2. 强制关闭所有相关进程（不需要确认）

```bash
python VIDEO/kill_all_realtime_processes.py --force
```

### 3. 只关闭指定任务ID的进程

```bash
python VIDEO/kill_all_realtime_processes.py --task-id 1
```

### 4. 强制关闭指定任务ID的进程

```bash
python VIDEO/kill_all_realtime_processes.py --force --task-id 1
```

## 选项说明

- `--force` 或 `-f`: 强制终止，不等待优雅退出，也不需要确认
- `--task-id` 或 `-t`: 只关闭指定任务ID的进程（不指定则关闭所有）

## 工作原理

1. **查找进程**：
   - 使用 `psutil`（如果已安装）或 `ps` 命令查找所有相关进程
   - 识别 `run_deploy.py` 主进程和 FFmpeg 子进程
   - 通过环境变量 `TASK_ID` 过滤进程（如果指定了任务ID）

2. **进程分组**：
   - 按进程组（PGID）分组进程
   - 这样可以一次性终止整个进程树

3. **终止进程**：
   - 先尝试优雅终止（SIGTERM）
   - 等待2秒后，如果进程仍在运行，强制终止（SIGKILL）
   - 使用进程组终止，确保所有子进程都被终止

4. **验证**：
   - 终止后再次检查是否还有遗留进程
   - 如果有，尝试强制终止

## 注意事项

1. **权限要求**：需要足够的权限来终止进程（通常需要 root 或进程所有者权限）

2. **数据安全**：强制终止进程可能导致数据丢失，建议在停止任务时使用正常的停止接口

3. **进程组**：脚本会尝试使用进程组终止，这样可以确保所有子进程都被终止

4. **psutil 依赖**：如果安装了 `psutil`，脚本会使用它来更准确地查找进程；否则会使用 `ps` 命令

## 使用场景

1. **紧急情况**：当进程无法通过正常方式停止时
2. **清理遗留进程**：清理那些在后台偷偷运行的进程
3. **调试**：在开发和调试时快速清理所有相关进程
4. **系统维护**：在系统维护时清理所有相关进程

## 示例输出

```
======================================================================
🔍 正在查找 realtime_algorithm_service 相关进程...
======================================================================

📋 发现 5 个相关进程:

📦 进程组 12345 (3 个进程):
   - PID:  12345, PPID:   1000 (TASK_ID=1)
     命令: python /opt/projects/easyaiot/VIDEO/services/realtime_algorithm_service/run_deploy.py...
   - PID:  12346, PPID:  12345
     命令: ffmpeg -i pipe:0 -c:v libx264...
   - PID:  12347, PPID:  12345
     命令: ffmpeg -i pipe:0 -c:v libx264...

⚠️  确定要终止这 5 个进程吗？(yes/no): yes

======================================================================
🛑 开始终止进程...
======================================================================

📦 终止进程组 12345 (3 个进程)...
   ✅ 进程组 12345 已终止

======================================================================
✅ 成功终止 5 个进程
======================================================================
```

## 相关脚本

- `cleanup_orphaned_processes.py`: 清理遗留进程（更温和的方式）
- `kill_all_realtime_processes.py`: 强制关闭所有进程（本脚本）

## 故障排除

如果脚本无法终止某些进程，可能的原因：

1. **权限不足**：尝试使用 `sudo` 运行脚本
2. **进程处于僵尸状态**：需要重启系统或使用系统工具清理
3. **进程被系统保护**：某些系统进程可能无法被终止

